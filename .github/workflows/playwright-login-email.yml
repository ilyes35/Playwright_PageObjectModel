name: Test de connexion Playwright sur Chrome avec envoi par email

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    - cron: "0 0 1 * *" # Chaque mois, le 1er jour √† 00:00 UTC

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout du d√©p√¥t
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Node.js
      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ D√©pendances
      - name: Installation des d√©pendances
        run: npm install

      # 4Ô∏è‚É£ Playwright
      - name: Installation des navigateurs Playwright
        run: npx playwright install --with-deps

      # 5Ô∏è‚É£ Ex√©cution du test Login.spec.js
      - name: Ex√©cution du test Login.spec.js sur Chrome
        run: |
          npx playwright test tests/demo/Login.spec.js --project=chrome --reporter=html,json > results.json

      # 6Ô∏è‚É£ Analyse du rapport JSON
      - name: Analyse du rapport JSON
        id: summary
        run: |
          passed=$(jq '[.suites[].specs[].tests[].results[] | select(.status=="passed")] | length' results.json)
          failed=$(jq '[.suites[].specs[].tests[].results[] | select(.status=="failed")] | length' results.json)
          echo "passed=$passed" >> $GITHUB_OUTPUT
          echo "failed=$failed" >> $GITHUB_OUTPUT

      # 7Ô∏è‚É£ Sauvegarder le rapport HTML comme artefact
      - name: Sauvegarder le rapport HTML
        uses: actions/upload-artifact@v4
        with:
          name: rapport-playwright
          path: playwright-report/

      # 8Ô∏è‚É£ Copier le rapport HTML et mettre √† jour latest.html
      - name: Copier rapport HTML et cr√©er latest.html
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          TARGET_DIR=docs/reports/run-$TIMESTAMP
          mkdir -p $TARGET_DIR
          cp -r playwright-report/* $TARGET_DIR
          cp $TARGET_DIR/index.html docs/reports/latest.html

      # 9Ô∏è‚É£ Commit et push pour GitHub Pages
      - name: Commit et push rapport HTML
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/reports
          git commit -m "Mise √† jour du rapport Playwright"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # üîü Envoyer le mail avec lien stable vers latest.html
      - name: Envoi du rapport par email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.mail.yahoo.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: >-
            Rapport Playwright Login -
            ${{ job.status == 'success' && '‚úÖ Succ√®s' ||
                job.status == 'failure' && '‚ùå √âchec' ||
                job.status == 'cancelled' && '‚ö†Ô∏è Annul√©' ||
                job.status }}
          to: "smailyes05@yahoo.fr"
          from: "smailyes05@yahoo.fr"
          content_type: text/html
          body: |
            <html>
              <body style="font-family: Arial, sans-serif; color:#333;">
                <!-- Version texte simple pour clients mail non HTML -->
                <div style="display:none;">
Rapport du test Playwright : Login.spec.js

R√©ussi: ${{ steps.summary.outputs.passed }}
√âchou√©: ${{ steps.summary.outputs.failed }}

Vous pouvez consulter le rapport complet ici : https://<TON-UTILISATEUR>.github.io/<NOM-DEPOT>/docs/reports/latest.html

Bonne journ√©e,
L‚Äô√©quipe QA
                </div>

                <!-- Version HTML -->
                <h2>Rapport du test Playwright : Login.spec.js</h2>
                <p>R√©ussi: ${{ steps.summary.outputs.passed }}</p>
                <p>√âchou√©: ${{ steps.summary.outputs.failed }}</p>
                <p>Vous pouvez consulter le rapport complet ici : 
                  <a href="https://ilyes35.github.io/Playwright_PageObjectModel/docs/reports/latest.html">Voir le rapport complet</a>
                </p>
                <p>Bonne journ√©e,</p>
                <p><strong>L‚Äô√©quipe QA</strong></p>
              </body>
            </html>
